# Story 2.4: Exit Detection & Goodbye Scene

## Status
**Complete** ✅

---

## Story

**As a** user,  
**I want** Arvis to say goodbye and fade out the lights when I leave my room,  
**so that** the room gracefully powers down and saves energy.

---

## Acceptance Criteria

1. Exit detected when: no motion for configured timeout (default 10 min)
2. Goodbye scene triggers automatically on exit
3. LED animation: smooth fade to off
4. Voice farewell: "Goodbye."
5. Scene plays immediately when timeout fires
6. Lights fully off after animation completes
7. Room state changes to EMPTY
8. Exit event published for logging/debugging
9. Unit tests verify exit detection and scene triggering

---

## Tasks / Subtasks

- [ ] **Task 1: Implement exit detection** (AC: 1, 7)
  - [ ] Exit logic already in PresenceAgent (from 2.2)
  - [ ] Publish `presence.exit_detected` event on timeout
  - [ ] Ensure state transitions to EMPTY

- [ ] **Task 2: Create exit intent handler** (AC: 2, 8)
  - [ ] Add to `src/intents/presence.py`
  - [ ] Implement `handle_exit(intent, ctx)` handler
  - [ ] Register with IntentRouter for `presence.exit` action

- [ ] **Task 3: Implement fade out animation** (AC: 3, 6)
  - [ ] Use existing `animate_fade_out()` in LEDController
  - [ ] Ensure smooth brightness transition to 0
  - [ ] 2 second fade duration
  - [ ] Mock mode logs animation

- [ ] **Task 4: Implement goodbye voice** (AC: 4)
  - [ ] Use TTS to speak "Goodbye."
  - [ ] Voice defined in SCENES["exit"]["voice"] config

- [ ] **Task 5: Orchestrate scene** (AC: 5)
  - [ ] Trigger voice first (short)
  - [ ] Start fade animation during/after voice
  - [ ] Ensure lights fully off at end

- [ ] **Task 6: Wire exit → intent flow**
  - [ ] PresenceAgent publishes exit event
  - [ ] IntentRouter routes to exit handler
  - [ ] Scene executes

- [ ] **Task 7: Write tests** (AC: 9)
  - [ ] Add to `tests/test_presence_agent.py` or new file
  - [ ] Test timeout triggers exit
  - [ ] Test scene components triggered
  - [ ] Test lights end up off

---

## Dev Notes

### Source Tree Reference
```
src/
├── agents/
│   └── presence_agent.py  # UPDATE (exit event)
├── intents/
│   └── presence.py        # UPDATE (exit handler)
└── controllers/
    └── led_controller.py  # Already has fade_out
```

### Exit Scene Definition (from config)
```python
SCENES = {
    "exit": {
        "color": "#000000",      # Off
        "brightness": 0.0,
        "animation": "fade_out",
        "voice": "Goodbye.",
    },
}
```

### Fade Out Animation
```python
def animate_fade_out(self, duration: float = 2.0):
    """
    Gradual fade from current brightness to off.
    - Steps: ~20 steps over duration
    - Easing: linear or ease-out
    """
```

### Event Flow
```
Timeout (no motion for 10 min)
    ↓
PresenceAgent triggers exit
    ↓
presence.exit_detected
    ↓
IntentRouter → handle_exit()
    ↓
TTS "Goodbye." → Fade out animation
    ↓
State → EMPTY
```

### Considerations
- Don't trigger exit if user is in SLEEP state (handled by state machine)
- Cancel any pending exit timer if motion detected

---

## Testing

- **Test location**: `tests/test_exit_scene.py`
- **Timeout testing**: Use short timeout (5s) for tests
- **Mock mode**: Test with mocked LED and audio
- **Run tests**: `pytest tests/test_exit_scene.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story creation | Sarah (PO) |

