# Story 3.5: Voice Override - "I'm Still Awake"

## Status
**Draft**

---

## Story

**As a** user,  
**I want** to say "Arvis, I'm still awake" to cancel automatic sleep mode,  
**so that** the lights don't turn off when I'm just lying down to relax.

---

## Acceptance Criteria

1. Voice command "I'm still awake" cancels pending sleep transition
2. Resets sleep timer (starts 10 min countdown again)
3. Confirmation: "Got it, staying awake."
4. Works during the 10-minute detection window
5. Does nothing if already in SLEEP state (use "lights on" instead)
6. `sleep.override` intent registered
7. Unit tests verify override logic

---

## Tasks / Subtasks

- [ ] **Task 1: Add sleep.override intent** (AC: 1, 6)
  - [ ] Register handler in `src/intents/presence.py`
  - [ ] Handle "I'm still awake", "not sleeping", etc.
  - [ ] Add to LLM system prompt

- [ ] **Task 2: Implement timer reset** (AC: 2)
  - [ ] VisionAgent exposes `reset_sleep_timer()`
  - [ ] Handler calls reset method
  - [ ] Timer starts fresh

- [ ] **Task 3: Voice confirmation** (AC: 3)
  - [ ] TTS: "Got it, staying awake."

- [ ] **Task 4: State validation** (AC: 4, 5)
  - [ ] Only works during sleep detection (not after)
  - [ ] If already SLEEP, suggest "lights on"

- [ ] **Task 5: Update LLM prompt**
  - [ ] Add `sleep.override` to available actions
  - [ ] Example phrases

- [ ] **Task 6: Write tests** (AC: 7)
  - [ ] Test override cancels timer
  - [ ] Test does nothing if already asleep
  - [ ] Test voice confirmation

---

## Dev Notes

### Source Tree Reference
```
src/
├── intents/
│   └── presence.py        # UPDATE (add sleep.override)
├── agents/
│   └── vision_agent.py    # UPDATE (reset_sleep_timer)
└── backends/
    └── llm_backend.py     # UPDATE (system prompt)
```

### Intent Handler
```python
@router.handler("sleep.override")
async def handle_sleep_override(intent: Intent, ctx: HandlerContext) -> None:
    """Handle 'I'm still awake' command."""
    
    # Check if we're in sleep detection window
    if ctx.state_manager.state == RoomState.SLEEP:
        ctx.audio_controller.say("You're already in sleep mode. Say 'lights on' to wake up.")
        return
    
    # Reset the sleep timer
    vision_agent.reset_sleep_timer()
    
    ctx.audio_controller.say("Got it, staying awake.")
```

### Voice Phrases
- "Arvis, I'm still awake"
- "Arvis, not sleeping"
- "Arvis, I'm awake"
- "Arvis, don't turn off the lights"

### LLM Prompt Addition
```
sleep.override - User wants to cancel automatic sleep mode
  Example: "I'm still awake", "not sleeping yet"
```

---

## Testing

- **Test location**: `tests/test_sleep_override.py`
- **Mock testing**: Inject sleep timer, trigger override
- **Real testing**: Lie down, say "I'm still awake"
- **Run tests**: `pytest tests/test_sleep_override.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story creation | Sarah (PO) |


