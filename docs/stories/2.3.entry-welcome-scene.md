# Story 2.3: Entry Detection & Welcome Scene

## Status
**Complete** ✅

---

## Story

**As a** user,  
**I want** Arvis to greet me with a warm golden light animation when I enter my room,  
**so that** I feel welcomed and the room comes alive.

---

## Acceptance Criteria

1. Entry detected when: motion AND prior state was EMPTY
2. Welcome scene triggers automatically on entry
3. LED animation: golden shimmer effect
4. Voice greeting: "Welcome back, Arman."
5. Scene plays within 500ms of motion detection
6. Scene only plays on EMPTY → OCCUPIED (not during OCCUPIED)
7. Entry event published for logging/debugging
8. Animation and voice play concurrently (not sequentially)
9. Unit tests verify entry detection and scene triggering

---

## Tasks / Subtasks

- [ ] **Task 1: Implement entry detection** (AC: 1, 6)
  - [ ] Create entry detection logic in PresenceAgent
  - [ ] Check `state == EMPTY` before triggering entry
  - [ ] Publish `presence.entry_detected` event

- [ ] **Task 2: Create entry intent handler** (AC: 2, 7)
  - [ ] Create `src/intents/presence.py`
  - [ ] Implement `handle_entry(intent, ctx)` handler
  - [ ] Register with IntentRouter for `presence.entry` action

- [ ] **Task 3: Implement golden shimmer animation** (AC: 3)
  - [ ] Add `animate_golden_shimmer()` to LEDController
  - [ ] Gold color (#FFD700) with brightness variation
  - [ ] 3 second animation duration
  - [ ] Mock mode logs animation

- [ ] **Task 4: Implement welcome voice** (AC: 4)
  - [ ] Use TTS to speak "Welcome back, Arman."
  - [ ] Voice defined in SCENES["welcome"]["voice"] config

- [ ] **Task 5: Orchestrate scene** (AC: 5, 8)
  - [ ] Start LED animation and TTS concurrently
  - [ ] Use asyncio.gather() for parallel execution
  - [ ] Ensure < 500ms from motion to scene start

- [ ] **Task 6: Wire entry → intent flow**
  - [ ] PresenceAgent publishes entry event
  - [ ] IntentRouter routes to entry handler
  - [ ] Or: direct scene trigger from PresenceAgent

- [ ] **Task 7: Write tests** (AC: 9)
  - [ ] Create `tests/test_entry_scene.py`
  - [ ] Test entry only fires from EMPTY state
  - [ ] Test scene components triggered
  - [ ] Test concurrent execution

---

## Dev Notes

### Source Tree Reference
```
src/
├── agents/
│   └── presence_agent.py  # UPDATE
├── intents/
│   └── presence.py        # NEW
└── controllers/
    └── led_controller.py  # UPDATE (shimmer animation)
```

### Welcome Scene Definition (from config)
```python
SCENES = {
    "welcome": {
        "color": "#FFD700",      # Gold
        "brightness": 0.7,
        "animation": "golden_shimmer",
        "voice": "Welcome back, Arman.",
    },
}
```

### Golden Shimmer Animation
```python
def animate_golden_shimmer(self, duration: float = 3.0):
    """
    Warm golden pulse effect.
    - Base color: #FFD700 (gold)
    - Brightness oscillates 0.5 → 1.0 → 0.5
    - Subtle "breathing" effect
    """
```

### Event Flow
```
PIR → presence.motion_detected
    ↓
PresenceAgent (if EMPTY → OCCUPIED)
    ↓
presence.entry_detected
    ↓
IntentRouter → handle_entry()
    ↓
LED animation + TTS (concurrent)
```

### Latency Target
- PIR trigger → scene start: < 500ms

---

## Testing

- **Test location**: `tests/test_entry_scene.py`
- **Mock mode**: Test with mocked LED and audio
- **Integration**: Manual test on Pi with PIR
- **Run tests**: `pytest tests/test_entry_scene.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story creation | Sarah (PO) |

