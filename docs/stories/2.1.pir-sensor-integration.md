# Story 2.1: PIR Sensor Integration

## Status
**Draft**

---

## Story

**As a** developer,  
**I want** to integrate a PIR sensor that detects motion via GPIO,  
**so that** the system can detect when someone enters or moves in the room.

---

## Acceptance Criteria

1. PIRSensor class reads GPIO pin state on Raspberry Pi
2. Mock mode works on macOS (simulated motion events)
3. Motion detection publishes `presence.motion_detected` event
4. Configurable GPIO pin number in config
5. Debounce logic prevents rapid-fire events (min 2s between detections)
6. Sensor status logged on startup
7. Clean shutdown releases GPIO resources
8. Unit tests verify event publishing

---

## Tasks / Subtasks

- [ ] **Task 1: Create PIRSensor class** (AC: 1, 2)
  - [ ] Create `src/sensors/pir_sensor.py`
  - [ ] Implement `PIRSensor` class
  - [ ] Add `start()` and `stop()` methods
  - [ ] Implement GPIO reading using `RPi.GPIO` or `gpiozero`
  - [ ] Add mock mode that simulates motion events

- [ ] **Task 2: Implement motion detection** (AC: 3, 5)
  - [ ] Set up GPIO interrupt or polling loop
  - [ ] Publish `presence.motion_detected` event on trigger
  - [ ] Implement debounce (2s minimum between events)
  - [ ] Log motion detections

- [ ] **Task 3: Configuration** (AC: 4)
  - [ ] Add `PIR_GPIO_PIN` to config (default: 17)
  - [ ] Add `PIR_DEBOUNCE_SECONDS` to config (default: 2)
  - [ ] Document GPIO wiring in comments

- [ ] **Task 4: Wire into main.py** (AC: 6, 7)
  - [ ] Initialize PIRSensor in Arvis class
  - [ ] Start sensor in `start()` method
  - [ ] Stop sensor in `stop()` method
  - [ ] Log sensor status on startup

- [ ] **Task 5: Write tests** (AC: 8)
  - [ ] Create `tests/test_pir_sensor.py`
  - [ ] Test mock mode event publishing
  - [ ] Test debounce logic
  - [ ] Test start/stop lifecycle

---

## Dev Notes

### Source Tree Reference
```
src/
├── sensors/
│   ├── __init__.py        # NEW
│   └── pir_sensor.py      # NEW
└── config.py              # UPDATE
```

### GPIO Wiring (HC-SR501)
```
PIR Sensor     Raspberry Pi 5
---------      --------------
VCC      →     5V (Pin 2)
GND      →     GND (Pin 6)
OUT      →     GPIO 17 (Pin 11)
```

### Event Published
```python
Event(
    type="presence.motion_detected",
    payload={"timestamp": datetime.now()},
    source="pir_sensor"
)
```

### Mock Mode Behavior
When `MOCK_HARDWARE=true`:
- No GPIO access attempted
- Provides `trigger_mock_motion()` method for testing
- Logs "[MOCK PIR] Motion detected"

### Dependencies
```
# For Pi (uncomment when on Pi)
RPi.GPIO>=0.7.1
# OR
gpiozero>=2.0
```

---

## Testing

- **Test location**: `tests/test_pir_sensor.py`
- **Mock mode**: Use mock mode on macOS
- **Pi testing**: Manual GPIO testing when on hardware
- **Run tests**: `pytest tests/test_pir_sensor.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story creation | Sarah (PO) |

