# Story 1.4: LED Control & Action Execution

## Status
**Draft**

---

## Story

**As a** user,  
**I want** to control my room lights with voice commands like "Arvis, lights on" or "Arvis, focus mode",  
**so that** I can adjust my environment hands-free.

---

## Acceptance Criteria

1. IntentRouter receives voice.command events and routes to handlers
2. LEDController can turn lights on/off
3. LEDController can set predefined scenes (focus, night mode)
4. ActionExecutor dispatches intents to appropriate controllers
5. Voice commands trigger LED changes + TTS confirmation
6. "Arvis, lights on" → lights turn on + "Lights on."
7. "Arvis, lights off" → lights turn off + "Lights off."
8. "Arvis, focus mode" → cool white 100% + "Focus mode."
9. "Arvis, night mode" → warm amber 30% + "Night mode."
10. Mock LED mode works on macOS (logs instead of GPIO)
11. Full voice-to-action loop works end-to-end
12. Unit tests verify intent routing and action execution

---

## Tasks / Subtasks

- [ ] **Task 1: Implement IntentRouter** (AC: 1)
  - [ ] Create `src/core/intent_router.py`
  - [ ] Implement `IntentRouter` class
  - [ ] Subscribe to `voice.command` events
  - [ ] Extract intent from event payload
  - [ ] Route intent to registered handlers
  - [ ] Implement handler registration (`register_handler`)

- [ ] **Task 2: Implement LEDController** (AC: 2, 3, 10)
  - [ ] Create `src/controllers/led_controller.py`
  - [ ] Implement `LEDController` class
  - [ ] Implement `set_on()` method
  - [ ] Implement `set_off()` method
  - [ ] Implement `set_color(r, g, b, brightness)` method
  - [ ] Implement `set_scene(scene_id)` method
  - [ ] Add mock mode (log actions instead of GPIO)
  - [ ] Load scene definitions from config

- [ ] **Task 3: Implement ActionExecutor** (AC: 4, 5)
  - [ ] Create `src/core/action_executor.py`
  - [ ] Implement `ActionExecutor` class
  - [ ] Accept LEDController and AudioController as dependencies
  - [ ] Implement `execute(intent)` method
  - [ ] Route to appropriate controller based on intent action

- [ ] **Task 4: Implement light intent handlers** (AC: 6, 7, 8, 9)
  - [ ] Create `src/intents/lights.py`
  - [ ] Implement `handle_lights_on(intent, ctx)` handler
  - [ ] Implement `handle_lights_off(intent, ctx)` handler
  - [ ] Implement `handle_lights_scene(intent, ctx)` handler
  - [ ] Each handler: execute LED action + TTS confirmation
  - [ ] Register handlers with IntentRouter

- [ ] **Task 5: Define scenes in config** (AC: 3, 8, 9)
  - [ ] Update `src/config.py` with scene definitions
  - [ ] Focus scene: `#FFFFFF`, brightness 1.0
  - [ ] Night mode: `#FFB347` (warm amber), brightness 0.3
  - [ ] Add wake, sleep, welcome scenes (for later)

- [ ] **Task 6: Wire everything in main.py** (AC: 11)
  - [ ] Initialize LEDController
  - [ ] Initialize ActionExecutor with controllers
  - [ ] Initialize IntentRouter with ActionExecutor
  - [ ] Register light intent handlers
  - [ ] Connect VoiceAgent → IntentRouter → ActionExecutor

- [ ] **Task 7: End-to-end testing** (AC: 11)
  - [ ] Test full flow: "Arvis" → "lights on" → lights change + voice
  - [ ] Test with mock hardware on macOS
  - [ ] Verify logs show correct actions

- [ ] **Task 8: Write unit tests** (AC: 12)
  - [ ] Create `tests/test_intent_router.py`
  - [ ] Create `tests/test_action_executor.py`
  - [ ] Create `tests/test_led_controller.py`
  - [ ] Create `tests/test_light_intents.py`
  - [ ] Test handler registration and routing
  - [ ] Test scene application

---

## Dev Notes

### Source Tree Reference
```
src/
├── core/
│   ├── intent_router.py    # NEW
│   └── action_executor.py  # NEW
├── controllers/
│   └── led_controller.py   # NEW
└── intents/
    └── lights.py           # NEW
```

### Intent Actions for This Story
| Action | Params | TTS Response |
|--------|--------|--------------|
| `lights.on` | `{}` | "Lights on." |
| `lights.off` | `{}` | "Lights off." |
| `lights.scene` | `{scene: "focus"}` | "Focus mode." |
| `lights.scene` | `{scene: "night"}` | "Night mode." |

### Scene Definitions
```python
SCENES = {
    "focus": {
        "color": "#FFFFFF",
        "brightness": 1.0,
        "voice": "Focus mode."
    },
    "night": {
        "color": "#FFB347",
        "brightness": 0.3,
        "voice": "Night mode."
    }
}
```

### LED Mock Mode
When `MOCK_HARDWARE=true`:
```python
def set_color(self, r, g, b, brightness):
    if self.mock_mode:
        logger.info(f"[MOCK LED] Set color: ({r},{g},{b}) @ {brightness}")
        return
    # Real GPIO code here
```

### Handler Registration Pattern
```python
@intent_router.register("lights.on")
async def handle_lights_on(intent: Intent, ctx: Context):
    await ctx.led.set_on()
    await ctx.audio.say("Lights on.")
```

### Dependencies
```
# For Pi (production)
rpi_ws281x>=5.0.0  # Uncomment when on Pi
```

---

## Testing

- **Test location**: `tests/`
- **Mock hardware**: Use `MOCK_HARDWARE=true` for macOS
- **Integration test**: Full voice loop with mocked audio input
- **Run tests**: `pytest tests/ -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-11-30 | 1.0 | Initial story creation | Sarah (PO) |

