# Story 1.5: Smart Plug Control

## Status
**Ready for Development**

---

## Story

**As a** user,  
**I want** to control smart plugs with voice commands like "Arvis, turn on the record player" or "Arvis, turn off the lamp",  
**so that** I can automate appliances and devices hands-free.

---

## Acceptance Criteria

1. SmartPlugController discovers Kasa devices on network startup
2. SmartPlugController can turn plugs on/off via local network API
3. SmartPlugController supports mock mode for development
4. Device intent handlers registered with IntentRouter
5. Voice commands trigger plug control + TTS confirmation
6. "Arvis, turn on the record player" â†’ plug turns on + "Record player on."
7. "Arvis, turn off the lamp" â†’ plug turns off + "Lamp off."
8. "Arvis, is the record player on?" â†’ checks status + reports state
9. LLM recognizes device control commands and extracts device name
10. Auto-discovery finds plugs by name set in Kasa app
11. Manual device registration by IP address supported
12. Energy monitoring data available (if device supports it)
13. Mock mode works on macOS (logs instead of network calls)
14. Unit tests verify controller and intent handlers

---

## Tasks / Subtasks

- [ ] **Task 1: Install python-kasa dependency** (AC: 2)
  - [ ] Add `python-kasa>=0.5.0` to `requirements.txt`
  - [ ] Document installation in README

- [ ] **Task 2: Implement SmartPlugController** (AC: 1, 2, 3, 10, 11, 12, 13)
  - [ ] Create `src/controllers/smart_plug_controller.py`
  - [ ] Implement `SmartPlugController` class
  - [ ] Implement `_discover_plugs()` async method using `kasa.Discover`
  - [ ] Implement `turn_on(device_id)` async method
  - [ ] Implement `turn_off(device_id)` async method
  - [ ] Implement `is_on(device_id)` async method
  - [ ] Implement `get_energy_usage(device_id)` async method (if supported)
  - [ ] Implement `register_device(device_id, ip_address)` for manual registration
  - [ ] Add mock mode (log actions instead of network calls)
  - [ ] Normalize device IDs from Kasa app aliases (lowercase, replace spaces with underscores)

- [ ] **Task 3: Update HandlerContext** (AC: 4)
  - [ ] Update `src/core/intent_router.py`
  - [ ] Add `smart_plug_controller: Optional[Any]` to `HandlerContext` dataclass

- [ ] **Task 4: Implement device intent handlers** (AC: 4, 5, 6, 7, 8)
  - [ ] Create `src/intents/devices.py`
  - [ ] Implement `handle_device_on(intent, ctx)` handler
  - [ ] Implement `handle_device_off(intent, ctx)` handler
  - [ ] Implement `handle_device_status(intent, ctx)` handler
  - [ ] Each handler: execute plug action + TTS confirmation
  - [ ] Register handlers with IntentRouter via `register_device_handlers()`

- [ ] **Task 5: Update LLM backend** (AC: 9)
  - [ ] Update `src/backends/llm_backend.py` system prompt
  - [ ] Add device control actions to known actions list:
    - `device.on` (params: device = "record_player" | "lamp" | "fan" | ...)
    - `device.off` (params: device = "record_player" | "lamp" | "fan" | ...)
    - `device.status` (params: device = "record_player" | ...)
  - [ ] Test LLM recognizes device names from natural language

- [ ] **Task 6: Wire controller in main.py** (AC: 1, 4)
  - [ ] Import `SmartPlugController` and `register_device_handlers`
  - [ ] Initialize `SmartPlugController` in `Arvis.__init__`
  - [ ] Add controller to `HandlerContext`
  - [ ] Register device handlers with IntentRouter
  - [ ] Ensure discovery runs on startup (async task)

- [ ] **Task 7: Add configuration** (AC: 11)
  - [ ] Update `src/config.py` with optional `SMART_PLUG_DEVICES` dict
  - [ ] Support manual IP registration for devices that don't auto-discover
  - [ ] Document device naming conventions

- [ ] **Task 8: End-to-end testing** (AC: 5, 6, 7, 8)
  - [ ] Test full flow: "Arvis" â†’ "turn on record player" â†’ plug on + voice
  - [ ] Test with mock hardware on macOS
  - [ ] Test with real Kasa plug on Pi
  - [ ] Verify auto-discovery finds devices
  - [ ] Test device status checking

- [ ] **Task 9: Write unit tests** (AC: 14)
  - [ ] Create `tests/test_smart_plug_controller.py`
  - [ ] Create `tests/test_device_intents.py`
  - [ ] Mock `python-kasa` library for tests
  - [ ] Test discovery, on/off, status checking
  - [ ] Test intent handler registration and routing

---

## Dev Notes

### Source Tree Reference
```
src/
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ smart_plug_controller.py  # NEW
â””â”€â”€ intents/
    â””â”€â”€ devices.py                 # NEW
```

### Intent Actions for This Story
| Action | Params | TTS Response |
|--------|--------|--------------|
| `device.on` | `{device: "record_player"}` | "Record player on." |
| `device.off` | `{device: "record_player"}` | "Record player off." |
| `device.status` | `{device: "record_player"}` | "Record player is on." / "Record player is off." |

### Device Naming Convention
- Kasa app alias: "Record Player" â†’ device_id: "record_player"
- Normalization: lowercase, replace spaces with underscores
- **Primary device mappings:**
  - "Lamp" or "Light" â†’ "lamp" (for room lighting)
  - "Record Player" â†’ "record_player" (for turntable)
- Example mappings:
  - "Record Player" â†’ "record_player"
  - "Lamp" â†’ "lamp"
  - "Desk Lamp" â†’ "desk_lamp"
  - "Fan" â†’ "fan"

### Auto-Discovery Flow
1. On startup, `SmartPlugController` calls `kasa.Discover.discover()`
2. UDP broadcast finds all Kasa devices on local network
3. Each device responds with IP address and alias
4. Controller stores devices in `self._plugs` dict keyed by normalized device_id
5. Devices available for control immediately after discovery

### Manual Registration
If auto-discovery fails, manually register by IP:
```python
await controller.register_device("record_player", "192.168.1.100")
```

### Mock Mode
When `MOCK_HARDWARE=true`:
```python
async def turn_on(self, device_id: str) -> bool:
    if self._mock_mode:
        logger.info(f"ðŸ”Œ [MOCK] Turn ON: {device_id}")
        return True
    # Real network call here
```

### Dependencies
```
python-kasa>=0.5.0  # Kasa device control library
```

### Energy Monitoring
KP125M plugs support energy monitoring. Access via:
```python
usage = await controller.get_energy_usage("record_player")
# Returns: {"power": 45.2, "voltage": 120.0, "current": 0.38}
```

---

## Testing

- **Test location**: `tests/`
- **Mock hardware**: Use `MOCK_HARDWARE=true` for macOS
- **Integration test**: Full voice loop with mocked Kasa devices
- **Hardware test**: Requires actual Kasa plug on same Wi-Fi network
- **Run tests**: `pytest tests/ -v`

### Manual Testing Steps
1. Set up Kasa plugs with Kasa app:
   - Name one "Lamp" (for room lighting)
   - Name one "Record Player" (for turntable)
2. Ensure plugs and Pi are on same Wi-Fi network
3. Start Arvis, verify discovery logs show both plugs found
4. Test voice commands:
   - "Arvis, turn on the lamp" â†’ lamp turns on + "Lamp on."
   - "Arvis, turn off the lamp" â†’ lamp turns off + "Lamp off."
   - "Arvis, turn on the record player" â†’ record player on + "Record player on."
   - "Arvis, turn off the record player" â†’ record player off + "Record player off."
5. Test status: "Arvis, is the lamp on?" â†’ reports current state

### Future Automation Ideas
- Turn on lamp when entering room (welcome scene)
- Turn off lamp when leaving room (exit scene)
- Turn on record player during focus mode
- Turn off lamp when entering sleep mode

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Initial story creation | Arman |

