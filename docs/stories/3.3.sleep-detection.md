# Story 3.3: Sleep Detection

## Status
**Draft**

---

## Story

**As a** user,  
**I want** the room to detect when I fall asleep,  
**so that** lights automatically dim and the room enters sleep mode.

---

## Acceptance Criteria

1. Sleep detected when: LYING in BED zone + low motion for 10 minutes
2. Room state transitions to SLEEP when sleep detected
3. Sleep scene triggers: lights fade to off silently
4. Motion tracking: frame-to-frame pixel change analysis
5. Configurable sleep timeout (default: 10 minutes)
6. `vision.sleep_state` event published on sleep/wake transitions
7. Sleep detection disabled when room is EMPTY
8. Unit tests verify sleep detection logic

---

## Tasks / Subtasks

- [ ] **Task 1: Implement motion tracking** (AC: 4)
  - [ ] Frame difference calculation
  - [ ] Motion threshold (low motion = < X% pixel change)
  - [ ] Rolling average over last N frames

- [ ] **Task 2: Implement sleep detection** (AC: 1, 5)
  - [ ] Track time in LYING + BED + low motion state
  - [ ] Start timer when conditions met
  - [ ] Reset timer if motion detected or posture changes
  - [ ] Trigger sleep after timeout

- [ ] **Task 3: State management** (AC: 2, 7)
  - [ ] Integrate with StateManager
  - [ ] OCCUPIED → SLEEP transition
  - [ ] Only trigger if room is OCCUPIED (not EMPTY)

- [ ] **Task 4: Sleep scene** (AC: 3)
  - [ ] Create `presence.sleep` intent handler
  - [ ] Silent lights fade (no voice)
  - [ ] Update room state

- [ ] **Task 5: Event publishing** (AC: 6)
  - [ ] Publish `vision.sleep_state` with state: sleeping/awake
  - [ ] Include timestamp and duration

- [ ] **Task 6: Write tests** (AC: 8)
  - [ ] Test sleep timer logic
  - [ ] Test motion threshold
  - [ ] Test state transitions

---

## Dev Notes

### Source Tree Reference
```
src/
├── agents/
│   └── vision_agent.py    # UPDATE (add sleep detection)
├── intents/
│   └── presence.py        # UPDATE (add sleep handler)
└── config.py              # UPDATE (SLEEP_TIMEOUT_MINUTES)
```

### Sleep Detection State Machine
```
OCCUPIED + LYING + BED + low_motion
    │
    ├── 10 min timer starts
    │
    ├── Motion detected → timer resets
    ├── Posture changes → timer resets
    ├── Leaves bed zone → timer resets
    │
    └── Timer completes → SLEEP state
         │
         └── Lights fade, room quiet
```

### Motion Calculation
```python
def calculate_motion(prev_frame, curr_frame):
    diff = cv2.absdiff(prev_frame, curr_frame)
    gray_diff = cv2.cvtColor(diff, cv2.COLOR_BGR2GRAY)
    motion_pixels = np.count_nonzero(gray_diff > 25)
    motion_percent = motion_pixels / gray_diff.size * 100
    return motion_percent  # Low motion < 1%
```

### Config
```python
SLEEP_TIMEOUT_MINUTES = 10
SLEEP_MOTION_THRESHOLD = 1.0  # Percent pixel change
```

---

## Testing

- **Test location**: `tests/test_sleep_detection.py`
- **Mock testing**: Inject test postures/motion
- **Real testing**: Lie in bed for 10+ minutes
- **Run tests**: `pytest tests/test_sleep_detection.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story creation | Sarah (PO) |


