# Story 3.1: Camera Integration

## Status
**Draft**

---

## Story

**As a** developer,  
**I want** to integrate a USB webcam for frame capture,  
**so that** the vision system can analyze posture and detect sleep/wake states.

---

## Acceptance Criteria

1. CameraAgent captures frames from USB webcam (Logitech C920)
2. Mock mode works on macOS (simulated/test frames)
3. Configurable frame rate (default: 5 FPS for processing)
4. Frames published as `vision.frame` events
5. Camera gracefully handles disconnection/reconnection
6. Resource cleanup on shutdown (camera released)
7. Frame resolution configurable (default: 640x480)
8. Unit tests verify frame capture and event publishing

---

## Tasks / Subtasks

- [ ] **Task 1: Create CameraAgent class** (AC: 1, 2)
  - [ ] Create `src/agents/camera_agent.py`
  - [ ] Implement `CameraAgent` class with OpenCV
  - [ ] Add `start()` and `stop()` methods
  - [ ] Implement mock mode with test images

- [ ] **Task 2: Implement frame capture loop** (AC: 3, 4)
  - [ ] Background task for continuous capture
  - [ ] Configurable FPS (throttle capture rate)
  - [ ] Publish `vision.frame` events with frame data
  - [ ] Skip frames if processing is slow

- [ ] **Task 3: Handle camera errors** (AC: 5, 6)
  - [ ] Detect camera disconnection
  - [ ] Auto-reconnect with backoff
  - [ ] Clean release of camera on stop
  - [ ] Log camera status

- [ ] **Task 4: Configuration** (AC: 7)
  - [ ] Add camera settings to config
  - [ ] CAMERA_INDEX, CAMERA_FPS, CAMERA_WIDTH, CAMERA_HEIGHT

- [ ] **Task 5: Wire into main.py**
  - [ ] Initialize CameraAgent
  - [ ] Start/stop with application lifecycle

- [ ] **Task 6: Write tests** (AC: 8)
  - [ ] Create `tests/test_camera_agent.py`
  - [ ] Test mock mode frame generation
  - [ ] Test event publishing
  - [ ] Test start/stop lifecycle

---

## Dev Notes

### Source Tree Reference
```
src/
├── agents/
│   └── camera_agent.py    # NEW
└── config.py              # UPDATE
```

### Dependencies
```
opencv-python>=4.8.0
```

### Frame Event
```python
Event(
    type="vision.frame",
    payload={
        "frame": np.ndarray,  # BGR image
        "timestamp": datetime,
        "frame_number": int,
    },
    source="camera_agent"
)
```

### Mock Mode
- Returns test images (solid color or pre-recorded)
- Allows `inject_test_frame()` for testing
- No actual camera access required

---

## Testing

- **Test location**: `tests/test_camera_agent.py`
- **Mock mode**: Use for CI/CD and macOS dev
- **Real camera**: Manual testing with C920
- **Run tests**: `pytest tests/test_camera_agent.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story creation | Sarah (PO) |


