# Story 2.2: Presence Agent & Room State Management

## Status
**Draft**

---

## Story

**As a** user,  
**I want** the room to track whether I'm present or away,  
**so that** appropriate scenes trigger automatically when I enter or leave.

---

## Acceptance Criteria

1. PresenceAgent subscribes to PIR motion events
2. Room transitions from EMPTY → OCCUPIED on first motion
3. Room transitions from OCCUPIED → EMPTY after timeout (no motion for X minutes)
4. StateManager tracks current room state
5. State changes publish `room.state_changed` events
6. Configurable timeout duration (default: 10 minutes)
7. Agent logs all state transitions
8. State persists across motion events (motion while OCCUPIED stays OCCUPIED)
9. Unit tests verify state machine behavior

---

## Tasks / Subtasks

- [ ] **Task 1: Create PresenceAgent** (AC: 1, 2, 8)
  - [ ] Create `src/agents/presence_agent.py`
  - [ ] Implement `PresenceAgent` class
  - [ ] Subscribe to `presence.motion_detected` events
  - [ ] Track last motion timestamp
  - [ ] Trigger EMPTY → OCCUPIED transition on motion

- [ ] **Task 2: Implement empty timeout** (AC: 3, 6)
  - [ ] Create background timer/task
  - [ ] Check time since last motion periodically
  - [ ] Trigger OCCUPIED → EMPTY after timeout
  - [ ] Publish `presence.room_empty_timeout` event
  - [ ] Make timeout configurable via `ROOM_EMPTY_TIMEOUT_MINUTES`

- [ ] **Task 3: Integrate with StateManager** (AC: 4, 5, 7)
  - [ ] Use existing StateManager for state transitions
  - [ ] Verify state transition rules allow EMPTY ↔ OCCUPIED
  - [ ] Log transitions with timestamps

- [ ] **Task 4: Wire into main.py** (AC: 1)
  - [ ] Initialize PresenceAgent
  - [ ] Pass event_bus and state_manager
  - [ ] Start/stop with application lifecycle

- [ ] **Task 5: Write tests** (AC: 9)
  - [ ] Create `tests/test_presence_agent.py`
  - [ ] Test EMPTY → OCCUPIED on motion
  - [ ] Test OCCUPIED stays OCCUPIED on more motion
  - [ ] Test timeout triggers EMPTY
  - [ ] Test state persistence

---

## Dev Notes

### Source Tree Reference
```
src/
├── agents/
│   └── presence_agent.py  # NEW
└── config.py              # UPDATE (if needed)
```

### State Transitions
```
EMPTY ─── (motion detected) ───→ OCCUPIED
OCCUPIED ─── (timeout) ───→ EMPTY
OCCUPIED ─── (motion) ───→ OCCUPIED (reset timer)
```

### Events Consumed
- `presence.motion_detected` — from PIRSensor

### Events Published
- `presence.room_empty_timeout` — when timeout fires
- `room.state_changed` — via StateManager (existing)

### Timeout Logic
```python
# Pseudocode
on_motion():
    last_motion = now()
    if state == EMPTY:
        transition_to(OCCUPIED)
    # Reset timeout timer

check_timeout():  # runs every 30s
    if state == OCCUPIED and (now() - last_motion) > TIMEOUT:
        transition_to(EMPTY)
```

---

## Testing

- **Test location**: `tests/test_presence_agent.py`
- **Mocking**: Mock EventBus and StateManager
- **Timer testing**: Use fast timeout (1s) for tests
- **Run tests**: `pytest tests/test_presence_agent.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story creation | Sarah (PO) |

