# Story 1.1: Project Foundation

## Status
**Ready for Review**

---

## Story

**As a** developer,  
**I want** a solid project foundation with event-driven architecture,  
**so that** I can build modular, testable components that communicate via events.

---

## Acceptance Criteria

1. Project structure matches architecture source tree
2. EventBus class implemented with publish/subscribe pattern
3. StateManager class tracks room state (EMPTY/OCCUPIED/SLEEP/WAKE)
4. Config module loads environment variables correctly
5. Models defined (Event, Intent, RoomState, Scene)
6. Logging configured with loguru
7. Main entrypoint (`main.py`) initializes core components
8. Mock mode flag allows running without hardware
9. Unit tests pass for EventBus and StateManager
10. Project runs on macOS without errors

---

## Tasks / Subtasks

- [x] **Task 1: Create project structure** (AC: 1)
  - [x] Create `src/core/` directory with `__init__.py`
  - [x] Create `src/agents/` directory with `__init__.py`
  - [x] Create `src/backends/` directory with `__init__.py`
  - [x] Create `src/controllers/` directory with `__init__.py`
  - [x] Create `src/intents/` directory with `__init__.py`
  - [x] Create `src/utils/` directory with `__init__.py`
  - [x] Create `tests/` directory with `conftest.py`
  - [x] Create `assets/sounds/` directory

- [x] **Task 2: Implement core models** (AC: 5)
  - [x] Create `src/core/models.py`
  - [x] Define `RoomState` enum (EMPTY, OCCUPIED, SLEEP, WAKE)
  - [x] Define `Event` dataclass (type, payload, timestamp, source)
  - [x] Define `Intent` dataclass (action, params, priority, source)
  - [x] Define `Scene` dataclass (id, lights, voice, animation)
  - [x] Define `LightConfig` dataclass (color, brightness)

- [x] **Task 3: Implement EventBus** (AC: 2)
  - [x] Create `src/core/event_bus.py`
  - [x] Implement `EventBus` class with async support
  - [x] Implement `publish(event)` method
  - [x] Implement `subscribe(event_type, handler)` method
  - [x] Implement `unsubscribe(event_type, handler)` method
  - [x] Support wildcard subscriptions (e.g., `presence.*`)

- [x] **Task 4: Implement StateManager** (AC: 3)
  - [x] Create `src/core/state_manager.py`
  - [x] Implement `StateManager` class
  - [x] Implement `get_state()` method
  - [x] Implement `set_state(state)` method with validation
  - [x] Implement `can_transition(from_state, to_state)` method
  - [x] Publish state change events to EventBus

- [x] **Task 5: Update config module** (AC: 4, 8)
  - [x] Update `src/config.py` with all settings from architecture
  - [x] Add `MOCK_HARDWARE` flag
  - [x] Add `DEBUG` flag
  - [x] Ensure all env vars load from `.env`
  - [x] Add scene definitions (welcome, focus, night, sleep, wake, exit)

- [x] **Task 6: Set up logging** (AC: 6)
  - [x] Configure loguru in `src/config.py` or `src/utils/logging.py`
  - [x] Set up file rotation (1 day, 7 days retention)
  - [x] Create log directory if not exists

- [x] **Task 7: Create main entrypoint** (AC: 7, 10)
  - [x] Update `src/main.py`
  - [x] Initialize EventBus
  - [x] Initialize StateManager
  - [x] Add CLI argument parsing (--mock-hardware, --debug)
  - [x] Add graceful shutdown handling
  - [x] Log startup message

- [x] **Task 8: Write unit tests** (AC: 9)
  - [x] Create `tests/test_event_bus.py`
  - [x] Test publish/subscribe functionality
  - [x] Test wildcard subscriptions
  - [x] Create `tests/test_state_manager.py`
  - [x] Test state transitions
  - [x] Test invalid transition rejection

---

## Dev Notes

### Source Tree Reference
```
src/
├── __init__.py
├── main.py
├── config.py
├── core/
│   ├── __init__.py
│   ├── models.py
│   ├── event_bus.py
│   └── state_manager.py
└── utils/
    └── __init__.py
```

### Key Patterns
- **EventBus**: Observer pattern with async handlers
- **StateManager**: Simple state machine, publishes `room.state_changed` events
- **Config**: Use `python-dotenv` to load `.env` file

### Event Types to Support
- `room.state_changed` — payload: `{old_state, new_state}`

### Dependencies
```
python-dotenv>=1.0.0
loguru>=0.7.0
pytest>=7.0.0
pytest-asyncio>=0.21.0
```

---

## Testing

- **Test location**: `tests/`
- **Framework**: pytest + pytest-asyncio
- **Run tests**: `pytest tests/ -v`
- **Coverage**: Focus on EventBus and StateManager logic

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-11-30 | 1.0 | Initial story creation | Sarah (PO) |
| 2024-11-30 | 1.1 | Implementation complete | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4 via Cursor IDE

### File List
**Created:**
- `src/core/__init__.py`
- `src/core/models.py`
- `src/core/event_bus.py`
- `src/core/state_manager.py`
- `src/agents/__init__.py`
- `src/backends/__init__.py`
- `src/controllers/__init__.py`
- `src/intents/__init__.py`
- `src/utils/__init__.py`
- `src/utils/logging.py`
- `src/main.py`
- `tests/__init__.py`
- `tests/conftest.py`
- `tests/test_event_bus.py`
- `tests/test_state_manager.py`
- `assets/sounds/` (directory)

**Modified:**
- `src/config.py` (updated with full configuration)
- `requirements.txt` (added test dependencies)

### Completion Notes
- All 8 tasks completed
- 33 unit tests passing
- Main application runs successfully with mock hardware
- Virtual environment created at `.venv/`
- Project structure matches architecture document

