# Story 1.1: Project Foundation

## Status
**Draft**

---

## Story

**As a** developer,  
**I want** a solid project foundation with event-driven architecture,  
**so that** I can build modular, testable components that communicate via events.

---

## Acceptance Criteria

1. Project structure matches architecture source tree
2. EventBus class implemented with publish/subscribe pattern
3. StateManager class tracks room state (EMPTY/OCCUPIED/SLEEP/WAKE)
4. Config module loads environment variables correctly
5. Models defined (Event, Intent, RoomState, Scene)
6. Logging configured with loguru
7. Main entrypoint (`main.py`) initializes core components
8. Mock mode flag allows running without hardware
9. Unit tests pass for EventBus and StateManager
10. Project runs on macOS without errors

---

## Tasks / Subtasks

- [ ] **Task 1: Create project structure** (AC: 1)
  - [ ] Create `src/core/` directory with `__init__.py`
  - [ ] Create `src/agents/` directory with `__init__.py`
  - [ ] Create `src/backends/` directory with `__init__.py`
  - [ ] Create `src/controllers/` directory with `__init__.py`
  - [ ] Create `src/intents/` directory with `__init__.py`
  - [ ] Create `src/utils/` directory with `__init__.py`
  - [ ] Create `tests/` directory with `conftest.py`
  - [ ] Create `assets/sounds/` directory

- [ ] **Task 2: Implement core models** (AC: 5)
  - [ ] Create `src/core/models.py`
  - [ ] Define `RoomState` enum (EMPTY, OCCUPIED, SLEEP, WAKE)
  - [ ] Define `Event` dataclass (type, payload, timestamp, source)
  - [ ] Define `Intent` dataclass (action, params, priority, source)
  - [ ] Define `Scene` dataclass (id, lights, voice, animation)
  - [ ] Define `LightConfig` dataclass (color, brightness)

- [ ] **Task 3: Implement EventBus** (AC: 2)
  - [ ] Create `src/core/event_bus.py`
  - [ ] Implement `EventBus` class with async support
  - [ ] Implement `publish(event)` method
  - [ ] Implement `subscribe(event_type, handler)` method
  - [ ] Implement `unsubscribe(event_type, handler)` method
  - [ ] Support wildcard subscriptions (e.g., `presence.*`)

- [ ] **Task 4: Implement StateManager** (AC: 3)
  - [ ] Create `src/core/state_manager.py`
  - [ ] Implement `StateManager` class
  - [ ] Implement `get_state()` method
  - [ ] Implement `set_state(state)` method with validation
  - [ ] Implement `can_transition(from_state, to_state)` method
  - [ ] Publish state change events to EventBus

- [ ] **Task 5: Update config module** (AC: 4, 8)
  - [ ] Update `src/config.py` with all settings from architecture
  - [ ] Add `MOCK_HARDWARE` flag
  - [ ] Add `DEBUG` flag
  - [ ] Ensure all env vars load from `.env`
  - [ ] Add scene definitions (welcome, focus, night, sleep, wake, exit)

- [ ] **Task 6: Set up logging** (AC: 6)
  - [ ] Configure loguru in `src/config.py` or `src/utils/logging.py`
  - [ ] Set up file rotation (1 day, 7 days retention)
  - [ ] Create log directory if not exists

- [ ] **Task 7: Create main entrypoint** (AC: 7, 10)
  - [ ] Update `src/main.py`
  - [ ] Initialize EventBus
  - [ ] Initialize StateManager
  - [ ] Add CLI argument parsing (--mock-hardware, --debug)
  - [ ] Add graceful shutdown handling
  - [ ] Log startup message

- [ ] **Task 8: Write unit tests** (AC: 9)
  - [ ] Create `tests/test_event_bus.py`
  - [ ] Test publish/subscribe functionality
  - [ ] Test wildcard subscriptions
  - [ ] Create `tests/test_state_manager.py`
  - [ ] Test state transitions
  - [ ] Test invalid transition rejection

---

## Dev Notes

### Source Tree Reference
```
src/
├── __init__.py
├── main.py
├── config.py
├── core/
│   ├── __init__.py
│   ├── models.py
│   ├── event_bus.py
│   └── state_manager.py
└── utils/
    └── __init__.py
```

### Key Patterns
- **EventBus**: Observer pattern with async handlers
- **StateManager**: Simple state machine, publishes `room.state_changed` events
- **Config**: Use `python-dotenv` to load `.env` file

### Event Types to Support
- `room.state_changed` — payload: `{old_state, new_state}`

### Dependencies
```
python-dotenv>=1.0.0
loguru>=0.7.0
pytest>=7.0.0
pytest-asyncio>=0.21.0
```

---

## Testing

- **Test location**: `tests/`
- **Framework**: pytest + pytest-asyncio
- **Run tests**: `pytest tests/ -v`
- **Coverage**: Focus on EventBus and StateManager logic

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-11-30 | 1.0 | Initial story creation | Sarah (PO) |

