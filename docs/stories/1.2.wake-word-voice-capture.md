# Story 1.2: Wake Word & Voice Capture

## Status
**Draft**

---

## Story

**As a** user,  
**I want** to say "Arvis" from anywhere in my room and have the system start listening,  
**so that** I can give voice commands hands-free.

---

## Acceptance Criteria

1. Porcupine wake word detector runs continuously in background
2. "Arvis" wake word is detected with 0.5 sensitivity
3. Wake word detection publishes `wake_word.detected` event
4. After wake word, system records audio until silence detected
5. Audio is captured at 16kHz mono (suitable for Whisper)
6. Recording stops after 3 seconds of silence or 10 seconds max
7. Audio bytes are available for STT processing
8. Wake word detector works on macOS (dev) and Pi (prod)
9. Mock mode allows testing without real microphone
10. Unit tests verify event publishing

---

## Tasks / Subtasks

- [ ] **Task 1: Set up Porcupine** (AC: 1, 2, 8)
  - [ ] Add `pvporcupine` to requirements.txt
  - [ ] Create `src/agents/wake_word.py`
  - [ ] Implement `WakeWordDetector` class
  - [ ] Initialize Porcupine with "Arvis" or "Jarvis" keyword
  - [ ] Set sensitivity to 0.5
  - [ ] Handle Porcupine access key from config

- [ ] **Task 2: Implement wake word detection loop** (AC: 1, 3)
  - [ ] Create async `start()` method
  - [ ] Read audio frames from microphone
  - [ ] Process frames through Porcupine
  - [ ] On detection, publish `wake_word.detected` event to EventBus
  - [ ] Create `stop()` method for graceful shutdown

- [ ] **Task 3: Implement audio recording** (AC: 4, 5, 6, 7)
  - [ ] Create `src/utils/audio_utils.py`
  - [ ] Implement `record_until_silence()` function
  - [ ] Configure: 16kHz sample rate, mono channel
  - [ ] Implement silence detection (VAD or energy-based)
  - [ ] Set max recording time to 10 seconds
  - [ ] Set silence threshold to 3 seconds
  - [ ] Return audio as bytes (WAV format for Whisper)

- [ ] **Task 4: Create VoiceAgent skeleton** (AC: 4, 7)
  - [ ] Create `src/agents/voice_agent.py`
  - [ ] Implement `VoiceAgent` class
  - [ ] Subscribe to `wake_word.detected` event
  - [ ] On wake word: call `record_until_silence()`
  - [ ] Store recorded audio for next story (STT processing)
  - [ ] Publish `voice.recording_complete` event with audio data

- [ ] **Task 5: Implement mock mode** (AC: 9)
  - [ ] Create `tests/mocks/mock_audio.py`
  - [ ] Implement `MockWakeWordDetector` that simulates detection
  - [ ] Implement `MockMicrophone` that returns test audio
  - [ ] Use mocks when `MOCK_HARDWARE=true`

- [ ] **Task 6: Wire into main.py** (AC: 1)
  - [ ] Initialize `WakeWordDetector` in main
  - [ ] Initialize `VoiceAgent` in main
  - [ ] Start wake word detection on startup
  - [ ] Handle graceful shutdown

- [ ] **Task 7: Write tests** (AC: 10)
  - [ ] Create `tests/test_wake_word.py`
  - [ ] Test that detection publishes event
  - [ ] Create `tests/test_voice_agent.py`
  - [ ] Test recording flow with mock audio

---

## Dev Notes

### Source Tree Reference
```
src/
├── agents/
│   ├── wake_word.py        # NEW
│   └── voice_agent.py      # NEW
└── utils/
    └── audio_utils.py      # NEW
```

### Porcupine Setup
- **Access Key**: Get free key from https://picovoice.ai/
- **Keyword**: Use built-in "Jarvis" (sounds like "Arvis") or train custom
- **Sensitivity**: 0.5 (balanced)

### Audio Format for Whisper
- Sample rate: 16000 Hz
- Channels: 1 (mono)
- Format: WAV or raw PCM
- Whisper accepts up to 25MB files

### Key Events
- `wake_word.detected` — payload: `{}`
- `voice.recording_complete` — payload: `{audio_bytes, duration}`

### Dependencies to Add
```
pvporcupine>=3.0.0
sounddevice>=0.4.6
numpy>=1.24.0
```

### Silence Detection Approach
Simple energy-based VAD:
```python
def is_silence(audio_chunk, threshold=500):
    return np.abs(audio_chunk).mean() < threshold
```

---

## Testing

- **Test location**: `tests/`
- **Framework**: pytest + pytest-asyncio
- **Mock audio**: Use pre-recorded test WAV file
- **Run tests**: `pytest tests/test_wake_word.py tests/test_voice_agent.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-11-30 | 1.0 | Initial story creation | Sarah (PO) |

