# Story 3.4: Wake Alarm System

## Status
**Draft**

---

## Story

**As a** user,  
**I want** an alarm that only stops when I get out of bed,  
**so that** I actually wake up instead of snoozing endlessly.

---

## Acceptance Criteria

1. Alarm can be set via voice: "Arvis, set alarm for 7 AM"
2. Alarm triggers at set time with voice: "Arman, wake up now"
3. Voice repeats every 10-15 seconds until dismissed
4. Alarm ONLY stops when feet detected on floor (bed → floor zone transition)
5. Sitting up in bed does NOT stop alarm
6. Lights do gentle sunrise fade during alarm
7. `alarm.triggered` and `alarm.dismissed` events published
8. Unit tests verify alarm logic

---

## Tasks / Subtasks

- [ ] **Task 1: Implement alarm scheduling** (AC: 1)
  - [ ] Create `src/controllers/alarm_controller.py`
  - [ ] Parse time from voice command
  - [ ] Schedule alarm with asyncio
  - [ ] Store active alarms

- [ ] **Task 2: Implement alarm trigger** (AC: 2, 3)
  - [ ] Voice loop: "Arman, wake up now"
  - [ ] Repeat every 10-15 seconds
  - [ ] Publish `alarm.triggered` event

- [ ] **Task 3: Implement feet-on-floor detection** (AC: 4, 5)
  - [ ] Track zone transitions (BED → FLOOR)
  - [ ] LYING→SITTING in BED = NOT dismissed
  - [ ] Person detected in FLOOR zone = dismissed
  - [ ] Clear transition required

- [ ] **Task 4: Sunrise lights** (AC: 6)
  - [ ] LED fade warm → bright over alarm duration
  - [ ] Start dim, increase gradually
  - [ ] Full brightness after ~2 minutes

- [ ] **Task 5: Alarm dismissal** (AC: 7)
  - [ ] Stop voice loop
  - [ ] Publish `alarm.dismissed` event
  - [ ] Transition room to WAKE state
  - [ ] Optional: play wake confirmation

- [ ] **Task 6: Voice intent handler**
  - [ ] Add `alarm.set` intent
  - [ ] Parse time (7 AM, 7:30, etc.)
  - [ ] Confirm: "Alarm set for 7 AM"

- [ ] **Task 7: Write tests** (AC: 8)
  - [ ] Test alarm scheduling
  - [ ] Test voice loop
  - [ ] Test dismissal logic
  - [ ] Test zone transition detection

---

## Dev Notes

### Source Tree Reference
```
src/
├── controllers/
│   └── alarm_controller.py  # NEW
├── intents/
│   └── alarm.py             # NEW
├── agents/
│   └── vision_agent.py      # UPDATE (bed exit detection)
└── config.py                # UPDATE
```

### Alarm Flow
```
User: "Arvis, set alarm for 7 AM"
    │
    ▼
[Alarm scheduled]
    │
    ▼
7:00 AM → alarm.triggered
    │
    ├── "Arman, wake up now" (repeat)
    ├── Lights: sunrise fade
    │
    ├── User sits up → STILL RINGING
    ├── User rolls over → STILL RINGING
    │
    └── User feet on floor → alarm.dismissed
         │
         └── "Good morning." + full lights
```

### Zone Transition Detection
```python
# In vision_agent.py
if previous_zone == Zone.BED and current_zone == Zone.FLOOR:
    if alarm_active:
        await event_bus.publish(Event(
            type="vision.bed_exit",
            payload={"timestamp": now},
            source="vision_agent"
        ))
```

### Alarm Intent
```python
# "Arvis, set alarm for 7 AM"
Intent(
    action="alarm.set",
    params={"time": "07:00"},
)
```

---

## Testing

- **Test location**: `tests/test_alarm_controller.py`
- **Mock testing**: Fast-forward time, inject zone changes
- **Real testing**: Set alarm, physically get out of bed
- **Run tests**: `pytest tests/test_alarm_controller.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story creation | Sarah (PO) |

