# Story 3.2: Posture Detection

## Status
**Draft**

---

## Story

**As a** user,  
**I want** the system to detect my posture (lying/sitting/standing),  
**so that** it can determine if I'm in bed, at my desk, or moving around.

---

## Acceptance Criteria

1. VisionAgent processes frames and detects posture
2. Posture states: LYING, SITTING, STANDING, UNKNOWN
3. Zone detection: BED, DESK, FLOOR (based on position in frame)
4. Posture changes publish `vision.posture_update` events
5. MediaPipe Pose used for skeleton detection
6. Debounce rapid posture changes (stable for 2s before publishing)
7. Mock mode returns configurable test postures
8. Unit tests verify posture classification

---

## Tasks / Subtasks

- [ ] **Task 1: Create VisionAgent class** (AC: 1)
  - [ ] Create `src/agents/vision_agent.py`
  - [ ] Subscribe to `vision.frame` events
  - [ ] Process frames with MediaPipe

- [ ] **Task 2: Implement posture detection** (AC: 2, 5)
  - [ ] Use MediaPipe Pose for skeleton
  - [ ] Calculate body angle/orientation
  - [ ] Classify: LYING (horizontal), SITTING (torso upright, legs bent), STANDING (upright)
  - [ ] Handle partial visibility

- [ ] **Task 3: Implement zone detection** (AC: 3)
  - [ ] Define bed zone coordinates in config
  - [ ] Define desk zone coordinates
  - [ ] Map detected person position to zone
  - [ ] Publish zone with posture updates

- [ ] **Task 4: Event publishing** (AC: 4, 6)
  - [ ] Publish `vision.posture_update` on changes
  - [ ] Include posture, zone, confidence
  - [ ] Debounce: only publish after 2s stable

- [ ] **Task 5: Mock mode** (AC: 7)
  - [ ] Skip MediaPipe processing
  - [ ] Return configurable test posture
  - [ ] Allow `set_mock_posture()` for testing

- [ ] **Task 6: Write tests** (AC: 8)
  - [ ] Create `tests/test_vision_agent.py`
  - [ ] Test posture classification logic
  - [ ] Test zone detection
  - [ ] Test debounce behavior

---

## Dev Notes

### Source Tree Reference
```
src/
├── agents/
│   ├── camera_agent.py    # From 3.1
│   └── vision_agent.py    # NEW
├── core/
│   └── models.py          # UPDATE (add Posture, Zone enums)
└── config.py              # UPDATE (zone coordinates)
```

### Dependencies
```
mediapipe>=0.10.0
```

### Posture Classification Logic
```python
# Simplified approach using shoulder-hip-ankle angles
if torso_angle < 30:  # Near horizontal
    return Posture.LYING
elif knee_angle < 120:  # Legs bent
    return Posture.SITTING
else:
    return Posture.STANDING
```

### Zone Configuration
```python
# Pixel coordinates (adjust for your camera angle)
ZONES = {
    "bed": {"x_min": 0, "x_max": 320, "y_min": 0, "y_max": 480},
    "desk": {"x_min": 320, "x_max": 640, "y_min": 0, "y_max": 300},
    "floor": {"x_min": 0, "x_max": 640, "y_min": 300, "y_max": 480},
}
```

### Event Published
```python
Event(
    type="vision.posture_update",
    payload={
        "posture": "lying",
        "zone": "bed",
        "confidence": 0.85,
        "timestamp": datetime,
    },
    source="vision_agent"
)
```

---

## Testing

- **Test location**: `tests/test_vision_agent.py`
- **Mock mode**: Test without camera
- **Real testing**: Use with webcam, move around
- **Run tests**: `pytest tests/test_vision_agent.py -v`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-01 | 1.0 | Initial story creation | Sarah (PO) |

